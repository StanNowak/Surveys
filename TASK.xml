<project name="avalanche-surveyjs-prototype">
  <context>
    <goal>Vanilla JS SurveyJS runner that loads external item bank + config + background, randomizes 2 AP testlets (uniform, no backend), shuffles within blocks, renders one-question-per-page with auto-advance, captures per-item timing, shows end-of-survey feedback, and downloads the full response as a JSON file on completion.</goal>
    <constraints>
      <c>No backend services. No BIB/quota API. No DB writes.</c>
      <c>External JSON files for background, bank, and config (swap without rebuild).</c>
      <c>Clean vanilla JS; easy to add serverless or Docker later without refactor.</c>
    </constraints>
  </context>

  <milestone id="M0" title="Scaffold repo & static page">
    <files>
      <add path="public/index.html"/>
      <add path="public/env.example.js"/>
      <add path="public/styles.css"/>
      <add path="src/main.js"/>
      <add path="README.md"/>
    </files>
    <steps>
      <s>Create index.html with &lt;div id="surveyContainer"&gt;, load survey-core (CDN CSS+JS), then env.js and src/main.js (type=module).</s>
      <s>env.example.js defines window.__SURVEY_CONFIG__ with BACKGROUND_URL, BANK_URL, CONFIG_URL, TITLE; leave SAVE_URL and QUOTA_ENDPOINT empty.</s>
      <s>README quickstart: copy env.example.js → env.js, run a static server (e.g., npx serve public).</s>
    </steps>
    <acceptance>
      <a>Opening /public/index.html via a static server shows an empty Survey container, no console errors.</a>
    </acceptance>
  </milestone>

  <milestone id="M1" title="Schemas + linter + demo data (incl. Background)">
    <files>
      <add path="src/schema/bank.schema.json"/>
      <add path="src/schema/config.schema.json"/>
      <add path="scripts/lint-bank.mjs"/>
      <add path="item-banks/background.json"/>
      <add path="item-banks/bank.demo.json"/>
      <add path="item-banks/config.demo.json"/>
    </files>
    <steps>
      <s>bank.schema.json: schema_version; testlets[ap_type,label,items[] {id,construct ∈ {development,behaviour,assessment,mitigation},form?,stem,choices[{value,text}],key,explain,tags?}]; diagnostics[] same Q/A + format.</s>
      <s>config.schema.json: routing (randomize_blocks, blocks_to_draw, randomize_within_block, include_diagnostics); quiz (feedback_mode, show_explanations); ui (one_question_per_page, auto_advance, progress_bar); background (enabled,url,splitOnePerPage).</s>
      <s>scripts/lint-bank.mjs validates: schema, unique ids, each testlet has all four constructs, each item has a single key present in choices, non-empty explain.</s>
      <s>background.json: add the four Background pages from our draft (activities, winters & days, training, services).</s>
      <s>bank.demo.json: Storm + Persistent (4 constructs each) and 3 diagnostics from our draft survey.</s>
      <s>config.demo.json: { "routing": { "randomize_blocks": true, "blocks_to_draw": 2, "randomize_within_block": true, "include_diagnostics": true }, "ui": { "one_question_per_page": true, "auto_advance": true, "progress_bar": true }, "quiz": { "feedback_mode": "full", "show_explanations": true }, "background": { "enabled": true, "url": "/item-banks/background.json", "splitOnePerPage": false } }.</s>
    </steps>
    <acceptance>
      <a>node scripts/lint-bank.mjs item-banks/bank.demo.json exits 0.</a>
    </acceptance>
  </milestone>

  <milestone id="M2" title="Builder + default logic (uniform random)">
    <files>
      <add path="src/builder.js"/>
      <add path="src/logic.default.js"/>
    </files>
    <steps>
      <s>builder: load background JSON (prepend pages); select 2 testlets uniformly from bank.testlets; within each, pick one item per construct (A/B random if multiple); if one_question_per_page: emit one page per question; else a page per testlet; append diagnostics as final pages.</s>
      <s>logic.default: expose hooks (onInit, selectBlocks [default uniform], selectItems, beforeRender, onGrade, onComplete) but keep defaults active.</s>
    </steps>
    <acceptance>
      <a>With bank.demo.json and config.demo.json, the survey renders: Background pages → 8 AP question pages (2×4) → 3 diagnostic pages.</a>
    </acceptance>
  </milestone>

  <milestone id="M3" title="Timing instrumentation (no backend)">
    <files>
      <add path="src/instrumentation.js"/>
    </files>
    <steps>
      <s>attachTiming(survey): onCurrentPageChanged capture per-page RT for single-question pages as rt_{questionName}_final (ms); track idle_ms via document.visibilitychange; ensure clearInvisibleValues='none'.</s>
    </steps>
    <acceptance>
      <a>Completing the demo survey yields rt_* fields for every question page and idle_ms in survey.data.</a>
    </acceptance>
  </milestone>

  <milestone id="M4" title="Grading + feedback + local download">
    <files>
      <add path="src/feedback.js"/>
    </files>
    <steps>
      <s>grade(model): per-item correctness using correctAnswer; renderFeedback(rows, mode): 'full' table (your vs correct + explanation) or 'summary'.</s>
      <s>In onComplete: set completedHtml=feedback; then trigger a JSON file download containing { ts, uuid, surveyVersion, bankVersion, data } via a Blob (no backend). UUID from ?uuid= or random.</s>
    </steps>
    <acceptance>
      <a>End screen shows score + table; a 'survey_&lt;uuid&gt;_&lt;ts&gt;.json' file is downloaded automatically.</a>
    </acceptance>
  </milestone>

  <milestone id="M5" title="Main glue + progress polish">
    <steps>
      <s>main.js: load env → background/bank/config; optional logic module if present; build pages; create Survey.Model({ clearInvisibleValues:'none', showQuestionNumbers:'off' }); set goNextPageAutomatic + hide nav if auto_advance; add top progress bar if configured; set hidden uuid.</s>
      <s>Verify one-question-per-page flow with auto-advance and that Back is off by default (or document the policy).</s>
    </steps>
    <acceptance>
      <a>Smoke test with /?uuid=PILOT1: Background → AP pages (auto-advance) → Diagnostics → feedback; download fires; uuid, background answers, AP answers, diagnostics, rt_*, idle_ms appear in the JSON.</a>
    </acceptance>
  </milestone>

  <milestone id="M6" title="Docs + dummy AP expansion (structure only)">
    <files>
      <add path="item-banks/bank.full.dummy.json"/>
    </files>
    <steps>
      <s>README: hosting (static), how to swap banks/config, how to pilot (download JSON), how to later enable SAVE_URL or BIB API (future).</s>
      <s>Create bank.full.dummy.json with all APs (storm, wind, persistent, deep_persistent, cornice, loose_dry, loose_wet, wet_slab). For each AP: 4 constructs, A/B variants, placeholder stems/choices/explain, valid keys. Include 3–6 diagnostics with placeholder content. Lint must pass.</s>
    </steps>
    <acceptance>
      <a>lint-bank passes on full dummy bank; app runs uniformly with any two APs.</a>
    </acceptance>
  </milestone>
</project>